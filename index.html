<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DASHBOARD KEUANGAN RT 04 RW 01 LATSARI</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
:root {
  --green:#00ff88;
  --dark:#222;
  --light:#fff;
  --gray:#ddd;
}
body {
  font-family:'Poppins',sans-serif;
  background:#111;
  color:#fff;
  margin:0;
  padding:0;
}
#menu {
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  background:#222;
  padding:10px;
  gap:8px;
}
#menu button {
  background:#333;
  border:none;
  color:#fff;
  padding:10px 14px;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
  transition:0.2s;
}
#menu button.active {
  background:var(--green);
  color:#000;
}
#menu button:hover { background:#00cc66; }

table {
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}
th,td {
  border:1px solid #333;
  padding:6px;
  text-align:center;
}
th {
  background:#00ff8844;
  color:#fff;
}
tr:nth-child(even){background:#222;}
tr:hover {background:#333;}
img {
  width:70px;
  border-radius:6px;
}
.pagination {
  display:flex;
  justify-content:center;
  margin:12px 0;
  gap:10px;
}
.pagination button {
  background:#333;
  border:none;
  color:#fff;
  padding:6px 12px;
  border-radius:6px;
  cursor:pointer;
}
.pagination button.active {
  background:var(--green);
  color:#000;
  font-weight:700;
}
#searchInput {
  width:95%;
  max-width:400px;
  margin:12px auto;
  display:block;
  padding:8px;
  border-radius:8px;
  border:none;
  outline:none;
  font-size:15px;
}
.highlight {
  background:yellow;
  color:#000;
  font-weight:bold;
}
.nominal-cell { text-align:right; }
</style>
</head>
<body>

<h2 style="text-align:center;margin-top:15px;">DASHBOARD KEUANGAN RT 04 RW 01 LATSARI</h2>

<div id="menu">
  <button data-sheet="hariini">Hari Ini</button>
  <button class="active" data-sheet="harian">Jimpitan Harian</button>
  <button data-sheet="bulanan">Warga Bulanan</button>
  <button data-sheet="pengeluaran">Pengeluaran</button>
  <button data-sheet="rekap">Rekap Keuangan</button>
</div>

<input type="text" id="searchInput" placeholder="Cari data..." />

<div id="tableContainer"></div>
<div class="pagination" id="pagination"></div>

<script>
const sheetsConfig={
  hariini:{
    sheetId:"1g1fp70L86yFkZt6OcOQjdKK9kgtHmPb2TqLou7a-4Pw",
    sheetName:"Laporan Jimpitan Harian",
    columns:["NO","TANGGAL","HARI JAGA","HADIR","IZIN","ALPHA","HASIL (Rp)","KETERANGAN","UPDATE"],
    query:"SELECT A,B,C,E,F,G,H,I",
    rowsPerPage:1
  },
  harian:{
    sheetId:"1g1fp70L86yFkZt6OcOQjdKK9kgtHmPb2TqLou7a-4Pw",
    sheetName:"Laporan Jimpitan Harian",
    columns:["NO","TANGGAL","HARI JAGA","HADIR","IZIN","ALPHA","HASIL (Rp)","KETERANGAN","FOTO"],
    query:"SELECT A,B,C,E,F,G,H,I",
    rowsPerPage:5
  },
  bulanan:{
    sheetId:"1g1fp70L86yFkZt6OcOQjdKK9kgtHmPb2TqLou7a-4Pw",
    sheetName:"Laporan Warga Bulanan",
    columns:["NO","NAMA","BLN","JIMPITAN (Rp)","LAINNYA (Rp)","TOTAL (Rp)"],
    query:"SELECT A,B,C,D,E,F",
    rowsPerPage:10
  },
  pengeluaran:{
    sheetId:"1g1fp70L86yFkZt6OcOQjdKK9kgtHmPb2TqLou7a-4Pw",
    sheetName:"Laporan Pengeluaran",
    columns:["NO","TANGGAL","KEPERLUAN","NOMINAL (Rp)","KETERANGAN","FOTO"],
    query:"SELECT A,B,C,D,E,F",
    rowsPerPage:5
  },
  rekap:{
    sheetId:"1g1fp70L86yFkZt6OcOQjdKK9kgtHmPb2TqLou7a-4Pw",
    sheetName:"Rekapitulasi Keuangan",
    columns:["NO","URAIAN","DEBET (Rp)","KREDIT (Rp)","SALDO (Rp)"],
    query:"SELECT A,B,C,D,E",
    rowsPerPage:10
  }
};

let currentSheet="harian";
let allData=[],filteredData=[];
let currentPage=1,currentKeyword="";

async function fetchData(){
  const cfg=sheetsConfig[currentSheet];
  const url=`https://docs.google.com/spreadsheets/d/${cfg.sheetId}/gviz/tq?tq=${encodeURIComponent(cfg.query)}&sheet=${encodeURIComponent(cfg.sheetName)}`;
  const res=await fetch(url);
  const txt=await res.text();
  const json=JSON.parse(txt.substr(47).slice(0,-2));
  const cols=json.table.cols.map(c=>c.label);
  allData=json.table.rows.map(r=>{
    const o={};
    cols.forEach((c,i)=>{ o[c.toUpperCase()]=r.c[i]?r.c[i].v:""; });
    if(o["TANGGAL"]) o["TANGGALOBJ"]=new Date(o["TANGGAL"]);
    return o;
  });
  renderTable();
}

function highlightText(text,keyword){
  if(!keyword) return text;
  const reg=new RegExp(`(${keyword})`,"gi");
  return text.replace(reg,"<span class='highlight'>$1</span>");
}

function getFilteredData(){
  if(!currentKeyword) return [...allData];
  const kw=currentKeyword.toLowerCase();
  return allData.filter(r=>Object.values(r).some(v=>String(v).toLowerCase().includes(kw)));
}

function renderTable(){
  const cfg=sheetsConfig[currentSheet];

  if(currentSheet==="hariini"){
    allData.sort((a,b)=>{
      const da=a["TANGGALOBJ"], db=b["TANGGALOBJ"];
      if(!da&&!db) return 0;
      if(!da) return 1;
      if(!db) return -1;
      return db - da;
    });
    filteredData=allData.slice(0,1);
  } else {
    filteredData=getFilteredData();
  }

  const container=document.getElementById("tableContainer");
  if(filteredData.length===0){
    container.innerHTML="<p style='text-align:center;'>Tidak ada data.</p>";
    document.getElementById("pagination").innerHTML="";
    return;
  }

  const start=(currentPage-1)*cfg.rowsPerPage;
  const pageData=filteredData.slice(start,start+cfg.rowsPerPage);

  let html="<table><thead><tr>";
  cfg.columns.forEach(c=>html+=`<th>${c}</th>`);
  html+="</tr></thead><tbody>";

  pageData.forEach(row=>{
    html+="<tr>";
    cfg.columns.forEach(col=>{
      const key=col.toUpperCase();
      let val=row[key]||"";
      let cls="";
      if(["HASIL (RP)","NOMINAL (RP)","DEBET (RP)","KREDIT (RP)","SALDO (RP)","TOTAL (RP)"].includes(key))
        cls="nominal-cell";
      if(["HADIR","IZIN","ALPHA"].includes(key)&&val)
        val=val.split("\n").map(l=>l.trim()).filter(Boolean).join("<br>");
      if(key==="FOTO"&&val) val=`<img src='${val}' alt='Foto'>`;
      else val=highlightText(String(val),currentKeyword);

      if(currentSheet==="hariini" && key==="UPDATE"){
        const now=new Date();
        val=now.toLocaleString("id-ID",{hour:"2-digit",minute:"2-digit",second:"2-digit"});
      }

      html+=`<td class='${cls}'>${val}</td>`;
    });
    html+="</tr>";
  });

  html+="</tbody></table>";
  container.innerHTML=html;

  const totalPages=Math.ceil(filteredData.length/cfg.rowsPerPage);
  let pg="";
  if(totalPages>1){
    for(let i=1;i<=totalPages;i++){
      pg+=`<button class='${i===currentPage?"active":""}' onclick='gotoPage(${i})'>${i}</button>`;
    }
  }
  document.getElementById("pagination").innerHTML=pg;
}

function gotoPage(n){currentPage=n;renderTable();}
document.querySelectorAll("#menu button").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll("#menu button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    currentSheet=btn.getAttribute("data-sheet");
    currentPage=1;
    fetchData();
  };
});

document.getElementById("searchInput").addEventListener("input",e=>{
  currentKeyword=e.target.value.trim();
  currentPage=1;
  renderTable();
});

fetchData();
</script>

</body>
</html>
