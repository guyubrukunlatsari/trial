<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DASHBOARD KEUANGAN RT 04 RW 01 LATSARI , TUBAN</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
:root{
  --green:#00ff88;
  --dark:#222;
  --bg:#111;
}

body{
  margin:0;
  font-family:Poppins, sans-serif;
  background:var(--bg);
  color:#fff;
}

#menu{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  padding:12px;
  background:#000;
}

#menu button{
  padding:8px 12px;
  border:1px solid var(--green);
  background:#000;
  color:var(--green);
  cursor:pointer;
  border-radius:6px;
}

#menu button.active{
  background:var(--green);
  color:#000;
  font-weight:700;
}

#menu button:hover{
  background:#00cc66;
}

#content{
  padding:10px;
}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:12px;
}

th,td{
  padding:8px;
  border:1px solid #444;
  text-align:left;
  font-size:14px;
}

th{
  background:#333;
}

#pagination{
  margin-top:10px;
  display:flex;
  gap:8px;
}

#pagination button{
  padding:6px 12px;
  color:#fff;
  background:#444;
  border:1px solid #666;
  cursor:pointer;
}

#pagination button.active{
  background:var(--green);
  color:#000;
}

#date-filter{
  margin-top:10px;
}

#date-filter input{
  padding:5px;
  background:#222;
  color:#fff;
  border:1px solid #666;
  border-radius:4px;
}
</style>
</head>

<body>

<!-- MENU -->
<div id="menu">
  <button data-sheet="hariini">Hari Ini</button> <!-- <<< tambahan HARI INI -->
  <button class="active" data-sheet="harian">Jimpitan Harian</button>
  <button data-sheet="bulanan">Warga Bulanan</button>
  <button data-sheet="pengeluaran">Pengeluaran</button>
  <button data-sheet="rekap">Rekap Keuangan</button>
</div>

<div id="content">
  <h2 id="title">Jimpitan Harian</h2>

  <div id="date-filter">
    <label>Dari tanggal: <input type="date" id="startDate"></label>
    <label>Sampai: <input type="date" id="endDate"></label>
    <button onclick="applyDateFilter()">Filter</button>
  </div>

  <table id="dataTable"></table>

  <div id="pagination"></div>
</div>

<script>

// ==================== CONFIG ===========================
const SHEET_ID = "1g1fp70L86yFkZt6OcOQjdKK9kgtHmPb2TqLou7a-4Pw";

const SHEETS = {
    hariini: {
        sheetName: "Laporan Jimpitan Harian",
        query: "SELECT A,B,C,E,F,G,H,I",
        columns: ["NO","TANGGAL","HARI JAGA","HADIR","IZIN","ALPHA","HASIL (Rp)","KETERANGAN"],
        rowsPerPage: 1
    },

    harian: {
        sheetName: "Laporan Jimpitan Harian",
        query: "SELECT A,B,C,E,F,G,H,I",
        columns: ["NO","TANGGAL","HARI JAGA","HADIR","IZIN","ALPHA","HASIL (Rp)","KETERANGAN"],
        rowsPerPage: 10
    },

    bulanan: {
        sheetName: "Laporan Warga Bulanan",
        query: "SELECT A,B,C,D,E,F,G",
        columns: ["NO","TANGGAL","NAMA WARGA","PERIODE BAYAR","NOMINAL (Rp)","KETERANGAN","FOTO"],
        rowsPerPage: 10
    },

    pengeluaran: {
        sheetName: "Laporan Pengeluaran",
        query: "SELECT A,B,C,D,E,F",
        columns: ["NO","TANGGAL","KEPERLUAN","NOMINAL (Rp)","KETERANGAN","FOTO"],
        rowsPerPage: 10
    },

    rekap: {
        sheetName: "Rekap Keuangan RT",
        query: "SELECT A,B",
        columns: ["DESKRIPSI","JUMLAH"],
        rowsPerPage: 100
    }
};

// ==================== VARIABEL ===========================
let currentSheet = "harian";
let allData = [];
let filteredData = [];
let currentPage = 1;
let keyword = "";

// ==================== HELPER ===========================
function rupiah(v){
    if(!v) return "-";
    const n = Number(String(v).replace(/\D/g,""));
    if(isNaN(n)) return v;
    return "Rp. " + n.toLocaleString("id-ID") + ",-";
}

function parseDate(val){
    if(!val) return "";
    if(val.startsWith("Date(")){
        const p = val.match(/Date\((\d+),(\d+),(\d+)\)/);
        const d = new Date(p[1],p[2],p[3]);
        return format(d);
    }
    const d = new Date(val);
    return isNaN(d) ? val : format(d);
}

function format(d){
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yy = d.getFullYear();
    return `${dd}-${mm}-${yy}`;
}

// ==================== FETCH DATA ===========================
function loadData(){
    const cfg = SHEETS[currentSheet];
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(cfg.sheetName)}&tq=${encodeURIComponent(cfg.query)}`;
    
    showLoading();

    fetch(url)
    .then(r => r.text())
    .then(txt => {
        const json = JSON.parse(txt.match(/setResponse\((.*)\)/)[1]);
        
        allData = json.table.rows.map(r => {
            const cells = r.c || [];
            const obj = {};
            cfg.columns.forEach((c, i)=>{
                obj[c] = cells[i] ? (cells[i].v ?? "") : "";
            });

            if(obj["TANGGAL"]) obj["TANGGAL"] = parseDate(obj["TANGGAL"]);
            if(obj["HASIL (Rp)"]) obj["HASIL (Rp)"]=rupiah(obj["HASIL (Rp)"]);
            if(obj["NOMINAL (Rp)"]) obj["NOMINAL (Rp)"]=rupiah(obj["NOMINAL (Rp)"]);
            if(obj["JUMLAH"]) obj["JUMLAH"]=rupiah(obj["JUMLAH"]);
            return obj;
        });

        // Urutkan
        if(currentSheet === "hariini" || currentSheet === "harian"){
            allData.sort((a,b)=>{
                return new Date(b["TANGGAL"]) - new Date(a["TANGGAL"]);
            });

            if(currentSheet === "hariini"){
                allData = allData.slice(0,1);
            }
        }
        else{
            allData.sort((a,b)=>{
                const na = Number(a.NO)||0;
                const nb = Number(b.NO)||0;
                return nb - na;
            });
        }

        filteredData = allData;
        currentPage = 1;
        renderTable();
        renderPagination();
    });
}

// ==================== RENDER TABLE ===========================
function renderTable(){
    const cfg = SHEETS[currentSheet];
    const head = document.getElementById("table-head");
    const body = document.getElementById("table-body");

    head.innerHTML = "";
    body.innerHTML = "";

    // header
    let h = "<tr>";
    cfg.columns.forEach(c => h += `<th>${c}</th>`);
    h += "</tr>";
    head.innerHTML = h;

    // slice
    const start = (currentPage-1)*cfg.rowsPerPage;
    const end = start + cfg.rowsPerPage;
    const view = filteredData.slice(start,end);

    if(view.length === 0){
        body.innerHTML = `<tr><td colspan="${cfg.columns.length}">Tidak ada data</td></tr>`;
        return;
    }

    view.forEach(row=>{
        let tr = "<tr>";
        cfg.columns.forEach(c=>{
            let val = row[c];
            if(c==="FOTO" && val) val = `<img src="${val}" alt="foto">`;
            tr += `<td>${val}</td>`;
        });
        tr += "</tr>";
        body.innerHTML += tr;
    });
}

// ==================== PAGINATION ===========================
function renderPagination(){
    const cfg = SHEETS[currentSheet];
    const div = document.getElementById("pagination");
    div.innerHTML = "";

    const pages = Math.ceil(filteredData.length / cfg.rowsPerPage);
    if(pages <=1 ) return;

    const prev=document.createElement("button");
    prev.textContent="⬅️";
    prev.disabled=currentPage===1;
    prev.onclick=()=>{currentPage--;renderTable();renderPagination();};
    div.appendChild(prev);

    for(let i=1;i<=pages;i++){
        const b=document.createElement("button");
        b.textContent=i;
        if(i===currentPage) b.classList.add("active");
        b.onclick=()=>{currentPage=i;renderTable();renderPagination();};
        div.appendChild(b);
    }

    const next=document.createElement("button");
    next.textContent="➡️";
    next.disabled=currentPage===pages;
    next.onclick=()=>{currentPage++;renderTable();renderPagination();};
    div.appendChild(next);
}

// ==================== UI ===========================
function showLoading(){
    const head = document.getElementById("table-head").innerHTML="";
    document.getElementById("table-body").innerHTML=
    `<tr><td colspan="99" style="text-align:center"><div class="loader"></div></td></tr>`;
}

document.querySelectorAll("#menu button").forEach(btn=>{
    btn.addEventListener("click", ()=>{
        document.querySelectorAll("#menu button").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        currentSheet = btn.dataset.sheet;
        currentPage=1;
        loadData();
    });
});

// ==================== INIT ===========================
document.addEventListener("DOMContentLoaded", ()=>{
    loadData();
    setInterval(loadData,60000);
});

</script>


</body>
</html>
