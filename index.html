<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>DASHBOARD RT 04 RW 01 LATSARI,TUBAN</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
:root {
  --green: #00ff88;
  --dark: #001a0d;
}
body {
  font-family: 'Poppins', sans-serif;
  margin: 0;
  background: #000;
  color: #fff;
  text-align: center;
}
#menu {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  margin: 20px 0;
  gap: 10px;
}
#menu button {
  background: #111;
  border: 2px solid var(--green);
  color: var(--green);
  font-weight: 600;
  padding: 10px 20px;
  border-radius: 8px;
  cursor: pointer;
  transition: 0.3s;
}
#menu button:hover {
  background: var(--green);
  color: #000;
}
#menu button.active {
  background: var(--green);
  color: #000;
  font-weight: 700;
}
#search {
  padding: 8px;
  width: 220px;
  border-radius: 6px;
  border: none;
  outline: none;
  font-size: 14px;
  margin-bottom: 10px;
}
table {
  width: 95%;
  margin: 15px auto;
  border-collapse: collapse;
}
th, td {
  border: 1px solid var(--green);
  padding: 8px;
  text-align: center;
}
th {
  background: var(--dark);
}
tfoot td {
  font-weight: 700;
  color: var(--green);
}
#info {
  margin-top: 10px;
  font-size: 13px;
  color: #ccc;
}
#clock {
  font-weight: 600;
  color: var(--green);
}
button.export {
  margin-top: 10px;
  background: var(--green);
  color: #000;
  border: none;
  padding: 8px 15px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
}
button.export:hover {
  opacity: 0.8;
}
</style>
</head>
<body>
<h2>DASHBOARD RT 04 RW 01 LATSARI,TUBAN</h2>

<div id="menu">
  <button class="active" data-sheet="hariini">Hari Ini</button>
  <button data-sheet="harian">Jimpitan Harian</button>
  <button data-sheet="bulanan">Warga Bulanan</button>
  <button data-sheet="pengeluaran">Pengeluaran</button>
  <button data-sheet="rekap">Rekap Keuangan</button>
</div>

<input type="text" id="search" placeholder="Cari data...">
<table id="dataTable">
  <thead></thead>
  <tbody></tbody>
  <tfoot></tfoot>
</table>

<button class="export" onclick="exportPDF()">Export ke PDF</button>
<div id="info">Diperbarui otomatis: <span id="lastUpdate">-</span> | <span id="clock"></span></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>
<script>
const SHEET_URLS = {
  harian: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzjNwESJhj-eGvY4RH3dsV2hT7D4bvD-MohbrKWuVN1iVvNflK4vYg0tKVCum9cbM2e_qyZt0SC4fq/pub?gid=0&single=true&output=csv",
  bulanan: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRoi3H4OvwDgoDwCtwngpA8ygNRyRpePtEkSt5pVVbDUgVwe1KcC2hb_H61gJoFP0/pub?gid=0&single=true&output=csv",
  pengeluaran: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTDAXKhv_Br6Yf0uA1PV0U_TvD4FxErUUtZfWUR3y2D7dWzKfRVR1yI7KfUJ9s6Tg/pub?gid=0&single=true&output=csv",
  rekap: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQWRBBKQpQy4GbKhP_HcZLxgYUJf8DF0UQEtbFTj-lbZpNgHTcmQbR_FXUOlspHA/pub?gid=0&single=true&output=csv",
  hariini: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzjNwESJhj-eGvY4RH3dsV2hT7D4bvD-MohbrKWuVN1iVvNflK4vYg0tKVCum9cbM2e_qyZt0SC4fq/pub?gid=0&single=true&output=csv"
};

let currentSheet="hariini", allData=[], filteredData=[], currentKeyword="";

// Fungsi parsing CSV agar tahan koma di dalam tanda kutip
function parseCSV(text){
  const rows = [];
  let row = [], insideQuote = false, cell = "";
  for(let i=0; i<text.length; i++){
    const c = text[i];
    if(c === '"'){
      insideQuote = !insideQuote;
    } else if(c === ',' && !insideQuote){
      row.push(cell.trim());
      cell = "";
    } else if((c === '\n' || c === '\r') && !insideQuote){
      if(cell || row.length){
        row.push(cell.trim());
        rows.push(row);
        row = [];
        cell = "";
      }
    } else {
      cell += c;
    }
  }
  if(cell || row.length) row.push(cell.trim()), rows.push(row);
  return rows.filter(r => r.join("").trim() !== "");
}

// Ambil data CSV dan tampilkan
async function fetchData(){
  const url = SHEET_URLS[currentSheet];
  const res = await fetch(url);
  const text = await res.text();
  const rows = parseCSV(text);
  if(rows.length === 0){ 
    document.querySelector("#dataTable tbody").innerHTML = "<tr><td>Data tidak ditemukan</td></tr>"; 
    return;
  }
  const headers = rows[0];
  allData = rows.slice(1).map(r=>{
    let obj={}; headers.forEach((h,i)=>obj[h.trim()]=r[i]?.trim()||""); 
    return obj;
  });

  if(currentSheet==="hariini" && allData.length>0){
    const maxNo = Math.max(...allData.map(d=>Number(d["NO"])||0));
    allData = allData.filter(d=>Number(d["NO"])===maxNo);
  }

  renderTable(allData);
  document.getElementById("lastUpdate").textContent = new Date().toLocaleString("id-ID");
}

// Render tabel
function renderTable(data){
  filteredData = data.filter(row => Object.values(row).join(" ").toLowerCase().includes(currentKeyword.toLowerCase()));
  const table = document.getElementById("dataTable");
  const keys = Object.keys(data[0] || {});
  if(keys.length===0){ 
    table.querySelector("thead").innerHTML = "";
    table.querySelector("tbody").innerHTML = "<tr><td>Data kosong</td></tr>";
    return;
  }
  table.querySelector("thead").innerHTML = `<tr>${keys.map(k=>`<th>${k}</th>`).join("")}</tr>`;
  table.querySelector("tbody").innerHTML = filteredData.map(row=>`<tr>${keys.map(k=>`<td>${row[k]}</td>`).join("")}</tr>`).join("");
  if(keys.includes("NOMINAL (Rp)")){
    const total = filteredData.reduce((a,b)=>a+(Number(b["NOMINAL (Rp)"].replace(/[^0-9]/g,""))||0),0);
    table.querySelector("tfoot").innerHTML = `<tr><td colspan="${keys.length}">TOTAL: Rp ${total.toLocaleString("id-ID")}</td></tr>`;
  } else table.querySelector("tfoot").innerHTML = "";
}

// Pencarian otomatis
document.getElementById("search").addEventListener("input", e=>{
  currentKeyword = e.target.value;
  renderTable(allData);
});

// Ganti menu
document.querySelectorAll("#menu button").forEach(btn=>{
  btn.onclick = ()=>{
    document.querySelectorAll("#menu button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    currentSheet = btn.dataset.sheet;
    fetchData();
  };
});

// Jam realtime
setInterval(()=>{
  document.getElementById("clock").textContent = new Date().toLocaleTimeString("id-ID");
},1000);

// Export ke PDF
function exportPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const title = document.querySelector("#menu button.active").textContent;
  doc.text(`Laporan ${title}`, 14, 10);
  doc.autoTable({ html: "#dataTable", startY: 20 });
  const filename = `${title.replace(/\s+/g,"_")}_${new Date().toLocaleDateString("id-ID")}.pdf`;
  doc.save(filename);
}

// Jalankan awal
fetchData();
setInterval(fetchData, 300000);
</script>
</body>
</html>
