<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DASHBOARD KEUANGAN RT 04 RW 01 LATSARI , TUBAN</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
:root{
  --green:#00ff88;
  --dark:#222;
  --bg:#111;
}

body{
  margin:0;
  font-family:Poppins, sans-serif;
  background:var(--bg);
  color:#fff;
}

#menu{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  padding:12px;
  background:#000;
}

#menu button{
  padding:8px 12px;
  border:1px solid var(--green);
  background:#000;
  color:var(--green);
  cursor:pointer;
  border-radius:6px;
}

#menu button.active{
  background:var(--green);
  color:#000;
  font-weight:700;
}

#menu button:hover{
  background:#00cc66;
}

#content{
  padding:10px;
}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:12px;
}

th,td{
  padding:8px;
  border:1px solid #444;
  text-align:left;
  font-size:14px;
}

th{
  background:#333;
}

#pagination{
  margin-top:10px;
  display:flex;
  gap:8px;
}

#pagination button{
  padding:6px 12px;
  color:#fff;
  background:#444;
  border:1px solid #666;
  cursor:pointer;
}

#pagination button.active{
  background:var(--green);
  color:#000;
}

#date-filter{
  margin-top:10px;
}

#date-filter input{
  padding:5px;
  background:#222;
  color:#fff;
  border:1px solid #666;
  border-radius:4px;
}
</style>
</head>

<body>

<!-- MENU -->
<div id="menu">
  <button data-sheet="hariini">Hari Ini</button> <!-- <<< tambahan HARI INI -->
  <button class="active" data-sheet="harian">Jimpitan Harian</button>
  <button data-sheet="bulanan">Warga Bulanan</button>
  <button data-sheet="pengeluaran">Pengeluaran</button>
  <button data-sheet="rekap">Rekap Keuangan</button>
</div>

<div id="content">
  <h2 id="title">Jimpitan Harian</h2>

  <div id="date-filter">
    <label>Dari tanggal: <input type="date" id="startDate"></label>
    <label>Sampai: <input type="date" id="endDate"></label>
    <button onclick="applyDateFilter()">Filter</button>
  </div>

  <table id="dataTable"></table>

  <div id="pagination"></div>
</div>

<script>
const SHEET_URL_BASE =
  "https://docs.google.com/spreadsheets/d/1g1fp70L86yFkZt6OcOQjdKK9kgtHmPb2TqLou7a-4Pw/gviz/tq?sheet=";

// CONFIG
const sheetsConfig = {

  // <<< tambahan HARI INI
  hariini:{
    sheetId:"1g1fp70L86yFkZt6OcOQjdKK9kgtHmPb2TqLou7a-4Pw",
    sheetName:"Laporan Jimpitan Harian",
    columns:["NO","TANGGAL","HARI JAGA","HADIR","IZIN","ALPHA","HASIL (Rp)","KETERANGAN"],
    query:"SELECT A,B,C,E,F,G,H,I",
    rowsPerPage:1
  },

  harian:{
    sheetId:"1g1fp70L86yFkZt6OcOQjdKK9kgtHmPb2TqLou7a-4Pw",
    sheetName:"Laporan Jimpitan Harian",
    columns:["NO","TANGGAL","HARI JAGA","HADIR","IZIN","ALPHA","HASIL (Rp)","KETERANGAN"],
    query:"SELECT A,B,C,E,F,G,H,I",
    rowsPerPage:10
  },

  bulanan:{
    sheetId:"1g1fp70L86yFkZt6OcOQjdKK9kgtHmPb2TqLou7a-4Pw",
    sheetName:"Warga Bulanan",
    columns:["NO","NAMA","RT","BULAN","TANGGAL BAYAR","TOTAL","PETUGAS","STATUS"],
    query:"SELECT A,B,C,D,E,F,G,H",
    rowsPerPage:10
  },

  pengeluaran:{
    sheetId:"1g1fp70L86yFkZt6OcOQjdKK9kgtHmPb2TqLou7a-4Pw",
    sheetName:"Pengeluaran",
    columns:["NO","TANGGAL","ITEM","NOMINAL","KETERANGAN"],
    query:"SELECT A,B,C,D,E",
    rowsPerPage:10
  },

  rekap:{
    sheetId:"1g1fp70L86yFkZt6OcOQjdKK9kgtHmPb2TqLou7a-4Pw",
    sheetName:"Rekap",
    columns:["BULAN","MASUK","KELUAR","TOTAL"],
    query:"SELECT A,B,C,D",
    rowsPerPage:12
  }
};

let currentSheet="harian";
let allData=[];
let filteredData=[];
let currentPage=1;

function fetchData(){
  const cfg=sheetsConfig[currentSheet];
  const queryUrl=`https://docs.google.com/spreadsheets/d/${cfg.sheetId}/gviz/tq?tq=${encodeURIComponent(cfg.query)}&sheet=${cfg.sheetName}`;

  fetch(queryUrl)
    .then(res => res.text())
    .then(text => {
      const json=JSON.parse(text.substr(47).slice(0,-2));
      const rows=json.table.rows;
      allData=rows.map(r=>{
        const obj={};
        cfg.columns.forEach((col,i)=>{
          obj[col]=r.c[i]?r.c[i].v:"";
        });

        if(obj["TANGGAL"]){
          obj["TANGGALOBJ"]=new Date(obj["TANGGAL"]);
        }
        return obj;
      });

      // SORTING
      if(currentSheet==="harian" || currentSheet==="hariini"){
          allData.sort((a,b)=>{
              const da=a["TANGGALOBJ"], db=b["TANGGALOBJ"];
              if(!da && !db) return 0;
              if(!da) return 1;
              if(!db) return -1;
              return db-da;
          });

          // <<< tambahan logika HARI INI
          if(currentSheet==="hariini"){
              allData = allData.slice(0,1);
          }

      } else {
          // untuk data bulanan & pengeluaran â†’ urutkan berdasarkan NO descending
          if(allData[0] && allData[0]["NO"] !== undefined){
            allData.sort((a,b)=>parseInt(b.NO)-parseInt(a.NO));
          }
      }

      filteredData=[...allData];
      currentPage=1;
      renderTable();
      renderPagination();

      toggleDateInputs(currentSheet==="rekap" || currentSheet==="hariini");
    });
}

function toggleDateInputs(disabled){
  document.getElementById("startDate").disabled=disabled;
  document.getElementById("endDate").disabled=disabled;
}

function renderTable(){
  const cfg=sheetsConfig[currentSheet];
  const start=(currentPage-1)*cfg.rowsPerPage;
  const end=start+cfg.rowsPerPage;
  const pageData=filteredData.slice(start,end);

  let html="<tr>";
  cfg.columns.forEach(col=>{
    html+=`<th>${col}</th>`;
  });
  html+="</tr>";

  pageData.forEach(row=>{
    html+="<tr>";
    cfg.columns.forEach(col=>{
      html+=`<td>${row[col]??""}</td>`;
    });
    html+="</tr>";
  });

  document.getElementById("dataTable").innerHTML=html;
}

function renderPagination(){
  const cfg=sheetsConfig[currentSheet];
  const totalPages=Math.ceil(filteredData.length/cfg.rowsPerPage);
  let html="";

  for(let i=1;i<=totalPages;i++){
    html+=`<button class="${i===currentPage?"active":""}" onclick="goPage(${i})">${i}</button>`;
  }

  document.getElementById("pagination").innerHTML=html;
}

function goPage(p){
  currentPage=p;
  renderTable();
  renderPagination();
}

function applyDateFilter(){
  if(currentSheet==="hariini" || currentSheet==="rekap") return;

  const s=document.getElementById("startDate").value;
  const e=document.getElementById("endDate").value;

  if(!s && !e){
    filteredData=[...allData];
  } else {
    const sd=new Date(s);
    const ed=new Date(e);
    filteredData=allData.filter(r=>{
      const d=r["TANGGALOBJ"];
      if(!d) return false;
      if(s && d<sd) return false;
      if(e && d>ed) return false;
      return true;
    });
  }

  currentPage=1;
  renderTable();
  renderPagination();
}

document.querySelectorAll("#menu button").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll("#menu button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    currentSheet=btn.dataset.sheet;
    document.getElementById("title").textContent=btn.textContent;
    fetchData();
  });
});

fetchData();
</script>

</body>
</html>
