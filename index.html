<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DASHBOARD KEUANGAN RT 04 RW 01 LATSARI , TUBAN</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  --green:#00ff88;
  --muted:#aaa;
  --bg:#0f0f0f;
  --panel:#1a1a1a;
  --accent:#00cc66;
}
body {
  font-family: 'Poppins', sans-serif;
  background-color: var(--bg);
  color: #f1f1f1;
  margin:0;
  padding:12px;
}
h1 {
  text-align:center;
  color:var(--green);
  margin-bottom:10px;
  font-size:1.2rem;
}
#menu {
  display:flex;
  justify-content:center;
  gap:10px;
  margin-bottom:10px;
  flex-wrap:wrap;
}
#menu button {
  padding:6px 12px;
  border:none;
  border-radius:6px;
  font-weight:600;
  cursor:pointer;
  transition:0.15s;
  background:var(--accent);
  color:#000;
}
#menu button.active { 
  background: #00ff88;
  color: #000;
  font-weight: 700;
}
#menu button:hover { 
  background: #00cc66;
  color: #fff;
}

.filter-container {
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:8px;
  margin-bottom:10px;
  align-items:center;
}
.filter-container label {
  color:#ddd;
  font-size:0.85rem;
  display:flex;
  gap:6px;
  align-items:center;
}
.filter-container input[type="date"], .filter-container input[type="text"], .filter-container button {
  padding:6px 8px;
  border-radius:6px;
  border:1px solid #333;
  background:var(--panel);
  color:#fff;
  font-size:0.9rem;
}
.filter-container input[type="text"]{ min-width:200px; }
.filter-container button { background:var(--accent); color:#000; font-weight:600; cursor:pointer; }
.filter-container button:hover{ background:var(--green); }

.table-wrapper {
  overflow-x:auto;
  -webkit-overflow-scrolling: touch;
  margin-bottom:10px;
  border-radius:6px;
  width: 100%;
}
table {
  width:100%;
  border-collapse:collapse;
  table-layout:auto;
}
th, td {
  padding:8px;
  font-size:0.85rem;
  border-bottom:1px solid #333;
  text-align:center;
  vertical-align:middle;
  word-wrap: break-word;
  overflow-wrap: break-word;
}
th { background-color:var(--accent); color:#000; font-weight:700; }
td.foto img { max-width:60px; max-height:50px; border-radius:4px; display:block; margin:auto; }
tr:nth-child(even){background:#171717;}
tr:hover{background:#222;}

.highlight{background:#00ff44;color:#000;font-weight:700;border-radius:3px;padding:0 3px;}
td.nominal-cell { color: var(--green) !important; font-weight:700; }

th:nth-child(1), td:nth-child(1) { width:2%; min-width:40px; max-width:60px; }
th:nth-child(2), td:nth-child(2),
th:nth-child(3), td:nth-child(3) { width:8%; min-width:80px; max-width:100px; }
th:nth-child(4), td:nth-child(4),
th:nth-child(5), td:nth-child(5),
th:nth-child(6), td:nth-child(6) { width:14%; min-width:140px; word-break: break-word; }
th:nth-child(7), td:nth-child(7) { width:7%; min-width:80px; max-width:100px; }

.pagination{display:flex; justify-content:center; flex-wrap:wrap; gap:6px; margin-top:8px;}
.pagination button{padding:6px 8px; border-radius:6px; font-size:0.85rem; background:#222; color:#ddd; border:1px solid #333;}
.pagination button.active{background:var(--green); color:#000; transform:scale(1.05);}
.pagination button:disabled{background:#333;color:#777; cursor:not-allowed;}

#update-time {text-align:center; color:var(--muted); font-size:0.78rem; margin-bottom:6px;}
#total-container { text-align:center; margin-top:6px; font-weight:700; color:var(--green); }
footer { text-align:center; font-size:11px; color:#777; margin-top:12px; }

.loader { border: 3px solid #333; border-top: 3px solid var(--green); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin:auto; }
@keyframes spin { 100% { transform: rotate(360deg); } }

@media(max-width:600px){
  .filter-container input[type="text"]{ min-width:120px; }
  th, td { padding:6px 4px; font-size:0.75rem; }
}
@media(max-width:400px){
  h1 { font-size:1rem; }
  #menu button { font-size:0.75rem; padding:3px 6px; }
}

body.rekap-active table#main-table {
  table-layout: fixed;
}
body.rekap-active table#main-table th:nth-child(1),
body.rekap-active table#main-table td:nth-child(1) {
  width: 70%;
  text-align: left;
}
body.rekap-active table#main-table th:nth-child(2),
body.rekap-active table#main-table td:nth-child(2) {
  width: 30%;
  text-align: right;
}
</style>
</head>
<body>
<h1>DASHBOARD KEUANGAN RT 04 RW 01 LATSARI , TUBAN</h1>

<div id="menu">
  <button data-sheet="hariini" class="active">Hari Ini</button>
  <button data-sheet="harian">Jimpitan Harian</button>
  <button data-sheet="rekap">Rekap Keuangan</button>
  <button data-sheet="warga">Laporan Warga Bulanan</button>
  <button data-sheet="pengeluaran">Laporan Pengeluaran</button>
</div>

<script>
const sheetsConfig = {
  hariini: {
    url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzjNwESJhj-eGvY4RH3dsV2hT7D4bvD-MohbrKWuVN1/pub?gid=0&single=true&output=csv",
    columns: ["NO","TANGGAL","NAMA","SETORAN (Rp)","PETUGAS","KETERANGAN","FOTO"]
  },
  harian: {
    url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzjNwESJhj-eGvY4RH3dsV2hT7D4bvD-MohbrKWuVN1/pub?gid=0&single=true&output=csv",
    columns: ["NO","TANGGAL","NAMA","SETORAN (Rp)","PETUGAS","KETERANGAN","FOTO"]
  },
  rekap: {
    url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzjNwESJhj-eGvY4RH3dsV2hT7D4bvD-MohbrKWuVN1/pub?gid=123456789&single=true&output=csv",
    columns: ["NO","KETERANGAN","JUMLAH"]
  },
  warga: {
    url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzjNwESJhj-eGvY4RH3dsV2hT7D4bvD-MohbrKWuVN1/pub?gid=987654321&single=true&output=csv",
    columns: ["NO","NAMA","RT","BULAN","JUMLAH (Rp)","KETERANGAN"]
  },
  pengeluaran: {
    url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFzjNwESJhj-eGvY4RH3dsV2hT7D4bvD-MohbrKWuVN1/pub?gid=1122334455&single=true&output=csv",
    columns: ["NO","TANGGAL","KEPERLUAN","NOMINAL (Rp)","KETERANGAN","FOTO"]
  }
};

let currentSheet = "hariini";
let allData = [];
let filteredData = [];
let currentPage = 1;
let currentKeyword = "";

function formatRupiah(num){ return "Rp " + Number(num||0).toLocaleString("id-ID"); }

function showLoading(){
  document.querySelector("#dataTable tbody").innerHTML = `<tr><td colspan="10">‚è≥ Memuat data...</td></tr>`;
}

function fetchData(){
  const activeBtn = document.querySelector("#menu button.active");
  const originalText = activeBtn.textContent;
  activeBtn.textContent = "‚è≥ " + originalText;
  activeBtn.disabled = true;
  showLoading();

  const cfg = sheetsConfig[currentSheet];
  fetch(cfg.url)
  .then(r=>r.text())
  .then(csv=>{
    const rows = csv.trim().split("\n").map(r=>r.split(","));
    const headers = rows[0].map(h=>h.trim().toUpperCase());
    allData = rows.slice(1).map(r=>{
      let o={};
      headers.forEach((h,i)=>o[h]=r[i]||"");
      return o;
    });

    // üîπ Khusus menu ‚ÄúHari Ini‚Äù ‚Üí hanya ambil baris dengan NO terbesar
    if(currentSheet==="hariini" && allData.length>0){
      const maxNo = Math.max(...allData.map(d=>Number(d["NO"])||0));
      allData = allData.filter(d=>Number(d["NO"])===maxNo);
    }

    renderTable();
  })
  .catch(()=>{
    document.querySelector("#dataTable tbody").innerHTML = `<tr><td colspan="10">‚ùå Gagal memuat data.</td></tr>`;
  })
  .finally(()=>{
    activeBtn.textContent = originalText;
    activeBtn.disabled = false;
  });
}

function renderTable(){
  const cfg = sheetsConfig[currentSheet];
  const tbody = document.querySelector("#dataTable tbody");
  if(!cfg){ tbody.innerHTML="<tr><td colspan='10'>Sheet tidak ditemukan.</td></tr>"; return; }

  filteredData = allData.filter(row=>{
    const keyword = currentKeyword.toLowerCase();
    return Object.values(row).some(v=>String(v).toLowerCase().includes(keyword));
  });

  const rowsPerPage = 10;
  const start = (currentPage-1)*rowsPerPage;
  const pageData = filteredData.slice(start,start+rowsPerPage);

  tbody.innerHTML = pageData.map(r=>{
    return `<tr>${cfg.columns.map(c=>{
      const val = r[c.toUpperCase()]||"";
      if(c.toLowerCase().includes("foto") && val) return `<td><img src="${val}" width="50"></td>`;
      return `<td>${val}</td>`;
    }).join("")}</tr>`;
  }).join("");

  document.getElementById("pageInfo").textContent = `Halaman ${currentPage} / ${Math.ceil(filteredData.length/rowsPerPage)||1}`;

  // Total khusus menu rekap
  if(currentSheet==="rekap"){
    const sum = filteredData.reduce((a,b)=>{
      const rawVal = b["JUMLAH"]||"0";
      const num = Number(String(rawVal).replace(/[^0-9]/g,""));
      return a+(isNaN(num)?0:num);
    },0);
    document.getElementById("total-container").textContent="Total: "+formatRupiah(sum);
  }else{
    document.getElementById("total-container").textContent="";
  }
}

document.getElementById("menu").addEventListener("click",e=>{
  if(e.target.tagName==="BUTTON"){
    document.querySelectorAll("#menu button").forEach(b=>b.classList.remove("active"));
    e.target.classList.add("active");
    currentSheet=e.target.dataset.sheet;
    currentPage=1;
    fetchData();
  }
});

document.getElementById("searchBox").addEventListener("input",e=>{
  currentKeyword=e.target.value;
  renderTable();
});

document.getElementById("pdfBtn").addEventListener("click",()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: "landscape" });
  const cfg = sheetsConfig[currentSheet];
  const title = document.querySelector("#menu button.active").textContent;
  doc.setFontSize(14);
  doc.text(title, 14, 15);
  doc.autoTable({
    startY: 20,
    head: [cfg.columns],
    body: filteredData.map(r => cfg.columns.map(c => String(r[c.toUpperCase()]||""))),
    styles: { fontSize: 8 },
  });
  const nowStr = new Date().toLocaleDateString("id-ID").replace(/\//g,"-");
  doc.save(`${title.replace(/\s/g,"_")}_${nowStr}.pdf`);
});

fetchData();
setInterval(fetchData,300000);
</script>
