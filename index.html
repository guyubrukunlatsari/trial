<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DASHBOARD KEUANGAN RT 04 RW 01 LATSARI , TUBAN</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  --green:#00ff88;
  --muted:#aaa;
  --bg:#0f0f0f;
  --panel:#1a1a1a;
  --accent:#00cc66;
}
body {
  font-family: 'Poppins', sans-serif;
  background-color: var(--bg);
  color: #f1f1f1;
  margin:0;
  padding:12px;
}
h1 {
  text-align:center;
  color:var(--green);
  margin-bottom:10px;
  font-size:1.2rem;
}
#menu {
  display:flex;
  justify-content:center;
  gap:10px;
  margin-bottom:10px;
  flex-wrap:wrap;
}
#menu button {
  padding:6px 12px;
  border:none;
  border-radius:6px;
  font-weight:600;
  cursor:pointer;
  transition:0.15s;
  background:var(--accent);
  color:#000;
}
  
/* Tombol aktif lebih terang dan teks lebih jelas */
#menu button.active { 
  background: #00ff88;  /* hijau terang */
  color: #000;          /* teks hitam agar kontras */
  font-weight: 700;     /* tebal supaya terlihat jelas */
}

/* Tombol saat hover */
#menu button:hover { 
  background: #00cc66;  /* hijau sedikit lebih gelap */
  color: #fff;          /* teks putih saat hover */
}
  
.filter-container {
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:8px;
  margin-bottom:10px;
  align-items:center;
}
.filter-container label {
  color:#ddd;
  font-size:0.85rem;
  display:flex;
  gap:6px;
  align-items:center;
}
.filter-container input[type="date"], .filter-container input[type="text"], .filter-container button {
  padding:6px 8px;
  border-radius:6px;
  border:1px solid #333;
  background:var(--panel);
  color:#fff;
  font-size:0.9rem;
}
.filter-container input[type="text"]{ min-width:200px; }
.filter-container button { background:var(--accent); color:#000; font-weight:600; cursor:pointer; }
.filter-container button:hover{ background:var(--green); }

/* ===== TABEL ===== */
.table-wrapper {
  overflow-x:auto;
  -webkit-overflow-scrolling: touch;
  margin-bottom:10px;
  border-radius:6px;
  width: 100%;
}
table {
  width:100%;
  border-collapse:collapse;
  table-layout:auto;
}
th, td {
  padding:8px;
  font-size:0.85rem;
  border-bottom:1px solid #333;
  text-align:center;
  vertical-align:middle;
  word-wrap: break-word;
  overflow-wrap: break-word;
}
th { background-color:var(--accent); color:#000; font-weight:700; }
td.foto img { max-width:60px; max-height:50px; border-radius:4px; display:block; margin:auto; }
tr:nth-child(even){background:#171717;}
tr:hover{background:#222;}

.highlight{background:#00ff44;color:#000;font-weight:700;border-radius:3px;padding:0 3px;}
td.nominal-cell { color: var(--green) !important; font-weight:700; }

/* Kolom spesifik default */
th:nth-child(1), td:nth-child(1) { width:2%; min-width:40px; max-width:60px; }
th:nth-child(2), td:nth-child(2),
th:nth-child(3), td:nth-child(3) { width:8%; min-width:80px; max-width:100px; }
th:nth-child(4), td:nth-child(4),
th:nth-child(5), td:nth-child(5),
th:nth-child(6), td:nth-child(6) { width:14%; min-width:140px; word-break: break-word; }
th:nth-child(7), td:nth-child(7) { width:7%; min-width:80px; max-width:100px; }

.pagination{display:flex; justify-content:center; flex-wrap:wrap; gap:6px; margin-top:8px;}
.pagination button{padding:6px 8px; border-radius:6px; font-size:0.85rem; background:#222; color:#ddd; border:1px solid #333;}
.pagination button.active{background:var(--green); color:#000; transform:scale(1.05);}
.pagination button:disabled{background:#333;color:#777; cursor:not-allowed;}

#update-time {text-align:center; color:var(--muted); font-size:0.78rem; margin-bottom:6px;}
#total-container { text-align:center; margin-top:6px; font-weight:700; color:var(--green); }
footer { text-align:center; font-size:11px; color:#777; margin-top:12px; }

.loader { border: 3px solid #333; border-top: 3px solid var(--green); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin:auto; }
@keyframes spin { 100% { transform: rotate(360deg); } }

/* ===== MEDIA QUERIES ===== */
@media(max-width:600px){
  .filter-container input[type="text"]{ min-width:120px; }
  th, td { padding:6px 4px; font-size:0.75rem; }
}
@media(max-width:400px){
  h1 { font-size:1rem; }
  #menu button { font-size:0.75rem; padding:3px 6px; }
}

/* ===== KHUSUS REKAP KEUANGAN ===== */
body.rekap-active table#main-table {
  table-layout: fixed;
}
body.rekap-active table#main-table th:nth-child(1),
body.rekap-active table#main-table td:nth-child(1) {
  width: 70%;  /* DESKRIPSI */
  text-align: left;
}
body.rekap-active table#main-table th:nth-child(2),
body.rekap-active table#main-table td:nth-child(2) {
  width: 30%;  /* JUMLAH */
  text-align: right;
}
</style>
</head>
<body>
<h1>DASHBOARD KEUANGAN RT 04 RW 01 LATSARI , TUBAN</h1>

<div id="menu">
  <button class="active" data-sheet="harian">Jimpitan Harian</button>
  <button data-sheet="bulanan">Warga Bulanan</button>
  <button data-sheet="pengeluaran">Pengeluaran</button>
  <button data-sheet="rekap">Rekap Keuangan</button>
</div>

<div id="update-time">Diperbarui otomatis: ‚è≥</div>

<div class="filter-container">
  <label>Dari: <input type="date" id="startDate"></label>
  <label>Sampai: <input type="date" id="endDate"></label>
  <input type="text" id="searchBox" placeholder="üîé Cari semua kolom..." />
  <button id="resetBtn">üîÑ Reset</button>
  <button id="pdfBtn">üìÑ Export PDF</button>
</div>

<div class="table-wrapper">
  <table id="main-table" role="table" aria-label="Data keuangan">
    <thead id="table-head"></thead>
    <tbody id="table-body"><tr><td colspan="8"><div class="loader"></div></td></tr></tbody>
  </table>
</div>

<div id="total-container"></div>
<div class="pagination" id="pagination"></div>
<footer>Data otomatis diperbarui dari Google Sheet</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
// ==== CONFIG & UTILS ====
const sheetsConfig = {
  harian:{ sheetId:"1g1fp70L86yFkZt6OcOQjdKK9kgtHmPb2TqLou7a-4Pw", sheetName:"Laporan Jimpitan Harian", columns:["NO","TANGGAL","HARI JAGA","HADIR","IZIN","ALPHA","HASIL (Rp)","KETERANGAN"], query:"SELECT A,B,C,E,F,G,H,I", rowsPerPage:10 },
  bulanan:{ sheetId:"1g1fp70L86yFkZt6OcOQjdKK9kgtHmPb2TqLou7a-4Pw", sheetName:"Laporan Warga Bulanan", columns:["NO","TANGGAL","NAMA WARGA","PERIODE BAYAR","NOMINAL (Rp)","KETERANGAN","FOTO"], query:"SELECT A,B,C,D,E,F,G", rowsPerPage:10 },
  pengeluaran:{ sheetId:"1g1fp70L86yFkZt6OcOQjdKK9kgtHmPb2TqLou7a-4Pw", sheetName:"Laporan Pengeluaran", columns:["NO","TANGGAL","KEPERLUAN","NOMINAL (Rp)","KETERANGAN","FOTO"], query:"SELECT A,B,C,D,E,F", rowsPerPage:10 },
  rekap:{ sheetId:"1g1fp70L86yFkZt6OcOQjdKK9kgtHmPb2TqLou7a-4Pw", sheetName:"Rekap Keuangan RT", columns:["DESKRIPSI","JUMLAH"], query:"SELECT A,B", rowsPerPage:1000 }
};

let currentSheet="harian", allData=[], filteredData=[], currentPage=1, currentKeyword="";

// parsing tanggal & format rupiah
function parseDate(val){ if(!val) return {text:"", raw:null}; if(typeof val==="string" && val.startsWith("Date(")){ const m=val.match(/Date\((\d+),(\d+),(\d+)/); if(m){ const d=new Date(Number(m[1]),Number(m[2]),Number(m[3])); return formatDateObj(d); } } if(/^\d{4}-\d{2}-\d{2}$/.test(val)){ return formatDateObj(new Date(val)); } if(/^\d{2}[-/]\d{2}[-/]\d{4}$/.test(val)){ const [dd,mm,yy]=val.split(/[-/]/); return formatDateObj(new Date(`${yy}-${mm}-${dd}`)); } return formatDateObj(new Date(val)); }
function formatDateObj(d){ if(!d||isNaN(d)) return {text:"", raw:null}; const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); const yy=d.getFullYear(); return {text:`${dd}-${mm}-${yy}`, raw:d}; }
function formatRupiah(val){ if(val===null||val===undefined||val==="") return "-"; const num=Number(String(val).replace(/[^0-9]/g,"")); return isNaN(num)?val:"Rp. "+num.toLocaleString("id-ID")+",-"; }

// ==== FETCH DATA ====
function showLoading(){ const cols=sheetsConfig[currentSheet].columns.length||8; document.getElementById("table-body").innerHTML=`<tr><td colspan="${cols}"><div class="loader"></div></td></tr>`; }
function fetchData(){
  showLoading(); currentKeyword=""; document.getElementById("searchBox").value="";
  const cfg=sheetsConfig[currentSheet];
  const url=`https://docs.google.com/spreadsheets/d/${cfg.sheetId}/gviz/tq?sheet=${encodeURIComponent(cfg.sheetName)}&tq=${encodeURIComponent(cfg.query)}`;
  fetch(url).then(r=>r.text()).then(rep=>{
    try{
      const json=JSON.parse(rep.match(/google\.visualization\.Query\.setResponse\((.*)\)/)[1]);
      const rows=json.table.rows.map(r=>r.c.map(c=>c?v=c.v:""));
      allData=rows.map(r=>{
        const t=parseDate(r[1]); let obj={};
        cfg.columns.forEach((col,idx)=> obj[col.toUpperCase()]=r[idx]||"");
        if(obj["TANGGAL"]) obj["TANGGALOBJ"]=t.raw;
        if(obj["TANGGAL"]) obj["TANGGAL"]=t.text||obj["TANGGAL"];
        if(obj["JUMLAH"]) obj["JUMLAH"]=formatRupiah(obj["JUMLAH"]);
        if(obj["HASIL (RP)"]) obj["HASIL (RP)"]=formatRupiah(obj["HASIL (RP)"]);
        if(obj["NOMINAL (RP)"]) obj["NOMINAL (RP)"]=formatRupiah(obj["NOMINAL (RP)"]);
        return obj;
      });
      allData.sort((a,b)=>{ const da=a["TANGGALOBJ"],db=b["TANGGALOBJ"]; if(!da&&!db) return 0; if(!da) return 1; if(!db) return -1; return db-da; });
      filteredData=allData;
      toggleDateInputs(currentSheet==="rekap");
      renderTable();
      const now=new Date();
      document.getElementById("update-time").textContent="Diperbarui otomatis: "+now.toLocaleString("id-ID",{ weekday:"short", day:"2-digit", month:"short", year:"numeric", hour:"2-digit", minute:"2-digit"});
    }catch(e){
      document.getElementById("table-body").innerHTML=`<tr><td colspan="${cfg.columns.length}">‚ùå Gagal memuat data</td></tr>`; console.error(e);
    }
  }).catch(err=>{
    document.getElementById("table-body").innerHTML=`<tr><td colspan="${cfg.columns.length}">‚ö†Ô∏è Tidak dapat mengambil data (cek koneksi / izin sheet)</td></tr>`; console.error(err);
  });
}
function toggleDateInputs(disable){ const s=document.getElementById("startDate"), e=document.getElementById("endDate"); if(disable){ s.value=""; e.value=""; s.disabled=true; e.disabled=true; s.style.opacity=0.6; e.style.opacity=0.6; } else{ s.disabled=false; e.disabled=false; s.style.opacity=1; e.style.opacity=1; } }
function getFilteredData(){
  const sDate=document.getElementById("startDate").value;
  const eDate=document.getElementById("endDate").value;
  const start=sDate?new Date(sDate+"T00:00:00"):null;
  const end=eDate?new Date(eDate+"T23:59:59"):null;
  const keyword=currentKeyword.trim().toLowerCase();
  return allData.filter(row=>{
    const tgl=row["TANGGALOBJ"] instanceof Date?row["TANGGALOBJ"]:null;
    let matchDate=true;
    if(start&&tgl) matchDate=tgl>=start;
    if(end&&tgl) matchDate=matchDate&&tgl<=end;
    const matchText=keyword?Object.values(row).some(v=>String(v).toLowerCase().includes(keyword)):true;
    return matchDate&&matchText;
  });
}

function renderTable(){
  filteredData=getFilteredData();
  const cfg=sheetsConfig[currentSheet];
  const thead=document.getElementById("table-head");
  const tbody=document.getElementById("table-body");
  tbody.innerHTML=""; thead.innerHTML="";
  const trh=document.createElement("tr");
  cfg.columns.forEach(c=>{ const th=document.createElement("th"); th.textContent=c; trh.appendChild(th); });
  thead.appendChild(trh);

  const start=(currentPage-1)*cfg.rowsPerPage;
  const end=start+cfg.rowsPerPage;
  const view=filteredData.slice(start,end);

  if(view.length===0){ tbody.innerHTML=`<tr><td colspan="${cfg.columns.length}">Tidak ada data</td></tr>`; document.getElementById("pagination").innerHTML=""; document.getElementById("total-container").textContent=""; return; }

  view.forEach(row=>{
    const tr=document.createElement("tr");
    tr.innerHTML=cfg.columns.map(col=>{
      const key=col.toUpperCase();
      let val=row[key]||"";
      let cls="";
      if(["HASIL (RP)","NOMINAL (RP)","JUMLAH"].includes(key)) cls="nominal-cell";
      if(["HADIR","IZIN","ALPHA"].includes(key)&&val) val=val.split("\n").map(l=>l.trim()).filter(Boolean).join("<br>");
      if(key==="FOTO"&&val) val=`<img src="${val}" alt="Foto">`; else val=highlightText(String(val),currentKeyword);
      return `<td class="${cls}">${val}</td>`;
    }).join("");
    tbody.appendChild(tr);
  });

  if(["harian","bulanan","pengeluaran"].includes(currentSheet)){
    const sum=filteredData.reduce((acc,row)=>{ const rawVal=(row["HASIL (RP)"]||row["NOMINAL (RP)"]||row["JUMLAH"])||""; const num=Number(String(rawVal).replace(/[^0-9]/g,"")); return acc+(isNaN(num)?0:num); },0);
    document.getElementById("total-container").textContent="Total: "+formatRupiah(sum);
  } else document.getElementById("total-container").textContent="";

  renderPagination();
}

function renderPagination(){
  const p=document.getElementById("pagination"); p.innerHTML="";
  const cfg=sheetsConfig[currentSheet];
  const pages=Math.ceil(filteredData.length/cfg.rowsPerPage);
  if(pages<=1) return;
  const prev=document.createElement("button"); prev.textContent="‚¨ÖÔ∏è"; prev.disabled=currentPage===1; prev.onclick=()=>{ currentPage--; renderTable(); }; p.appendChild(prev);

  for(let i=1;i<=pages;i++){ const b=document.createElement("button"); b.textContent=i; if(i===currentPage) b.classList.add("active"); b.onclick=()=>{ currentPage=i; renderTable(); }; p.appendChild(b); }

  const next=document.createElement("button"); next.textContent="‚û°Ô∏è"; next.disabled=currentPage===pages; next.onclick=()=>{ currentPage++; renderTable(); }; p.appendChild(next);
}

function highlightText(text,keyword){ if(!keyword) return text; const esc=keyword.replace(/[-/\\^$*+?.()|[\]{}]/g,'\\$&'); const re=new RegExp('('+esc+')','gi'); return text.replace(re,'<span class="highlight">$1</span>'); }

function exportPDF(){
  const { jsPDF }=window.jspdf; const doc=new jsPDF('l','pt','a4'); const cfg=sheetsConfig[currentSheet]; const title=document.querySelector("#menu button.active").textContent;
  doc.setFontSize(12); doc.text(title,40,20);
  const body=filteredData.map(row=>cfg.columns.map(c=>{ const key=c.toUpperCase(); let v=row[key]||""; if(key==="FOTO") return ""; return String(v); }));
  doc.autoTable({ head:[cfg.columns], body, startY:40, theme:'grid', styles:{ fontSize:8, cellPadding:3, halign:'center' } });
  doc.save(`${title.replace(/\s/g,"_")}.pdf`);
}

/* ==== UI handlers ==== */
document.getElementById("searchBox").addEventListener("input", e=>{ currentKeyword=e.target.value.toLowerCase(); currentPage=1; renderTable(); });
document.getElementById("startDate").addEventListener("change", ()=>{ currentPage=1; renderTable(); });
document.getElementById("endDate").addEventListener("change", ()=>{ currentPage=1; renderTable(); });
document.getElementById("resetBtn").addEventListener("click", ()=>{
  document.getElementById("searchBox").value=""; document.getElementById("startDate").value=""; document.getElementById("endDate").value="";
  currentKeyword=""; currentPage=1; renderTable();
});
document.getElementById("pdfBtn").addEventListener("click", exportPDF);

/* menu switching */
document.querySelectorAll("#menu button").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll("#menu button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    currentSheet=btn.dataset.sheet;
    currentPage=1; currentKeyword="";
    document.getElementById("searchBox").value="";
    document.getElementById("startDate").value=""; document.getElementById("endDate").value="";
    document.body.classList.remove("rekap-active");
    if(currentSheet==="rekap") document.body.classList.add("rekap-active");
    fetchData();
  });
});

/* initial load & auto refresh */
fetchData(); setInterval(fetchData,60000);
</script>
</body>
</html>
